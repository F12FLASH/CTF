import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { CheckCircle2, Circle } from "lucide-react";
import { useLanguage } from "@/contexts/LanguageContext";
import { ExploitStep } from "@shared/schema";

interface ExploitGuideProps {
  steps: ExploitStep[];
}

export function ExploitGuide({ steps }: ExploitGuideProps) {
  const { language, t } = useLanguage();

  return (
    <section className="container mx-auto px-4 py-12">
      <div className="mb-8">
        <h2 className="font-heading text-3xl font-bold tracking-tight mb-2" data-testid="text-guide-section-title">
          {t("Exploitation Guide", "Hướng dẫn khai thác")}
        </h2>
        <p className="text-muted-foreground" data-testid="text-guide-section-description">
          {t("Step-by-step walkthrough to solve The Black Hole challenge", "Hướng dẫn từng bước để giải quyết thử thách Lỗ Đen")}
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg" data-testid="text-guide-title">
            {t("GOT Overwrite Technique", "Kỹ thuật ghi đè GOT")}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Accordion type="single" collapsible className="w-full">
            {steps.map((step) => (
              <AccordionItem key={step.id} value={`step-${step.id}`}>
                <AccordionTrigger className="hover:no-underline" data-testid={`accordion-step-${step.id}`}>
                  <div className="flex items-center gap-3 text-left">
                    <Badge variant="outline" className="font-mono text-xs shrink-0">
                      {t("Step", "Bước")} {step.id}
                    </Badge>
                    <span className="font-semibold">
                      {language === "vi" ? step.titleVi : step.title}
                    </span>
                  </div>
                </AccordionTrigger>
                <AccordionContent>
                  <div className="space-y-4 pt-2 pl-12">
                    <p className="text-muted-foreground leading-relaxed">
                      {language === "vi" ? step.descriptionVi : step.description}
                    </p>

                    {step.code && (
                      <div className="relative">
                        <div className="absolute top-3 right-3">
                          <Badge variant="secondary" className="font-mono text-xs">
                            {step.codeLanguage}
                          </Badge>
                        </div>
                        <pre className="overflow-x-auto rounded-md bg-muted/50 p-4 font-mono text-sm leading-relaxed">
                          <code className="text-foreground">{step.code}</code>
                        </pre>
                      </div>
                    )}

                    <div className="flex items-center gap-2 text-sm">
                      <CheckCircle2 className="h-4 w-4 text-primary" />
                      <span className="text-muted-foreground">
                        {t("Complete this step to progress", "Hoàn thành bước này để tiến bộ")}
                      </span>
                    </div>
                  </div>
                </AccordionContent>
              </AccordionItem>
            ))}
          </Accordion>

          <div className="mt-6 rounded-md bg-primary/10 p-4 border border-primary/20">
            <h4 className="font-semibold mb-2 flex items-center gap-2">
              <Circle className="h-4 w-4 text-primary" />
              {t("Key Insight", "Ý tưởng chính")}
            </h4>
            <p className="text-sm text-muted-foreground leading-relaxed">
              {language === "vi"
                ? "Việc ghi đè GOT của exit thành syscall gadget là chìa khóa để mở rộng khả năng thực thi trong môi trường bị hạn chế nghiêm ngặt bởi seccomp. Kỹ thuật này cho phép chuyển đổi các syscall được phép thành các syscall bị chặn."
                : "Overwriting exit's GOT entry with a syscall gadget is the key to expanding execution capabilities in an environment strictly restricted by seccomp. This technique allows transforming permitted syscalls into blocked ones."}
            </p>
          </div>
        </CardContent>
      </Card>
    </section>
  );
}
