#include "self_modify.h"
#include <sys/mman.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>

static unsigned char hidden_code[64] = {
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90
};

void init_self_modify(void) {
    long page_size = sysconf(_SC_PAGESIZE);
    void *page_start = (void *)((uintptr_t)hidden_code & ~(page_size - 1));
    
    if (mprotect(page_start, page_size, PROT_READ | PROT_WRITE | PROT_EXEC) != 0) {
        perror("mprotect failed");
        return;
    }
}

void reveal_code(void) {
    unsigned char real_code[] = {
        0x55,
        0x48, 0x89, 0xe5,
        0xb8, 0x2a, 0x00, 0x00, 0x00,
        0x5d,
        0xc3
    };
    
    memcpy(hidden_code, real_code, sizeof(real_code));
}

int execute_hidden_function(void) {
    int (*func)(void) = (int (*)(void))hidden_code;
    return func();
}
