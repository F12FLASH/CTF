import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Slider } from "@/components/ui/slider";
import { Play, RefreshCw, Copy, AlertCircle } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { StatsPanel } from "@/components/stats-panel";
import { AttemptLog } from "@/components/attempt-log";
import { useQuery, useMutation } from "@tanstack/react-query";
import { queryClient, apiRequest } from "@/lib/queryClient";
import type { ExploitAttempt, InsertExploitAttempt } from "@shared/schema";
import { Skeleton } from "@/components/ui/skeleton";
import { useLanguage } from "@/components/app-sidebar";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function ExploitBuilder() {
  const { toast } = useToast();
  const { lang } = useLanguage();
  const [offset, setOffset] = useState(264);
  const [maxAttempts, setMaxAttempts] = useState(1000);
  const [timeout, setTimeout] = useState(1000);
  const [code, setCode] = useState(`#!/usr/bin/env python3
from pwn import *

# The Phoenix exploit
context.arch = 'amd64'
context.log_level = 'info'

# Configuration
OFFSET = 264
MAX_ATTEMPTS = 1000

def exploit():
    p = process('./phoenix')
    
    # Build payload with partial overwrite
    payload = b"A" * OFFSET
    payload += p16(0x1234)  # Partial address overwrite
    
    p.sendline(payload)
    
    try:
        response = p.recvline(timeout=1)
        return response
    except:
        return b"timeout"
    finally:
        p.close()

if __name__ == "__main__":
    exploit()`);

  const { data: attempts = [], isLoading, error } = useQuery<ExploitAttempt[]>({
    queryKey: ["/api/attempts"],
  });

  const createAttemptMutation = useMutation({
    mutationFn: async (data: InsertExploitAttempt) => {
      return await apiRequest("POST", "/api/attempts", data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/attempts"] });
    },
    onError: (error: any) => {
      toast({
        title: lang === "vi" ? "Lỗi" : "Error",
        description: error.message || (lang === "vi" ? "Không thể tạo thử nghiệm" : "Failed to create attempt"),
        variant: "destructive",
      });
    },
  });

  const handleRun = () => {
    const payloadPreview = `b"A" * ${offset} + p16(0x${Math.floor(Math.random() * 0xFFFF).toString(16)})`;
    const duration = Math.floor(Math.random() * 500) + 100;
    const isSuccess = Math.random() > 0.7;
    
    const attemptData: InsertExploitAttempt = {
      payload: code,
      payloadPreview,
      result: isSuccess ? "shell" : "crash",
      duration,
      status: isSuccess ? "success" : "crash",
    };

    createAttemptMutation.mutate(attemptData, {
      onSuccess: () => {
        toast({
          title: isSuccess 
            ? (lang === "vi" ? "Thành Công!" : "Success!")
            : (lang === "vi" ? "Thử Nghiệm Thất Bại" : "Attempt Failed"),
          description: `${lang === "vi" ? "Kết quả" : "Result"}: ${attemptData.result} (${duration}ms)`,
        });
      },
    });
  };

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    toast({
      title: lang === "vi" ? "Đã Sao Chép!" : "Copied!",
      description: lang === "vi" ? "Mã exploit đã được sao chép" : "Exploit code copied to clipboard",
    });
  };

  const stats = {
    totalAttempts: attempts.length,
    successRate: attempts.length > 0 
      ? Math.round((attempts.filter(a => a.status === "success").length / attempts.length) * 100) 
      : 0,
    avgTime: attempts.length > 0
      ? Math.round(attempts.reduce((sum, a) => sum + a.duration, 0) / attempts.length)
      : 0,
    currentStreak: attempts.filter((a, i) => i < 3 && a.status === "success").length,
  };

  return (
    <div className="flex flex-col lg:flex-row h-full min-h-0">
      <div className="flex-1 p-4 lg:p-6 space-y-4 lg:space-y-6 overflow-y-auto min-h-0">
        <div className="space-y-2">
          <h1 className="text-2xl font-bold">
            {lang === "vi" ? "Xây Dựng Exploit" : "Exploit Builder"}
          </h1>
          <p className="text-sm text-muted-foreground">
            {lang === "vi" 
              ? "Xây dựng và kiểm tra exploit cho thử thách The Phoenix"
              : "Build and test your exploit for The Phoenix challenge"}
          </p>
        </div>

        {error && (
          <Alert variant="destructive">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription>
              {lang === "vi" 
                ? "Không thể tải dữ liệu. Vui lòng thử lại."
                : "Failed to load data. Please try again."}
            </AlertDescription>
          </Alert>
        )}

        <Card className="p-4 lg:p-6 space-y-4">
          <div className="space-y-2">
            <Label htmlFor="code-editor" className="text-sm font-medium">
              {lang === "vi" ? "Mã Exploit" : "Exploit Code"}
            </Label>
            <Textarea
              id="code-editor"
              value={code}
              onChange={(e) => setCode(e.target.value)}
              className="font-mono text-xs min-h-[300px] lg:min-h-[400px] resize-none"
              placeholder={lang === "vi" ? "Nhập mã exploit của bạn..." : "Enter your exploit code here..."}
              data-testid="textarea-exploit-code"
            />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="space-y-2">
              <Label htmlFor="offset" className="text-xs font-medium uppercase tracking-wide">
                {lang === "vi" ? "Offset Buffer" : "Buffer Offset"}
              </Label>
              <div className="flex items-center gap-2">
                <Input
                  id="offset"
                  type="number"
                  value={offset}
                  onChange={(e) => setOffset(parseInt(e.target.value) || 0)}
                  className="font-mono"
                  data-testid="input-offset"
                />
                <span className="text-xs text-muted-foreground">bytes</span>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="max-attempts" className="text-xs font-medium uppercase tracking-wide">
                {lang === "vi" ? "Số Lần Thử Tối Đa" : "Max Attempts"}
              </Label>
              <Input
                id="max-attempts"
                type="number"
                value={maxAttempts}
                onChange={(e) => setMaxAttempts(parseInt(e.target.value) || 1)}
                className="font-mono"
                data-testid="input-max-attempts"
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="timeout" className="text-xs font-medium uppercase tracking-wide">
                Timeout (ms)
              </Label>
              <Input
                id="timeout"
                type="number"
                value={timeout}
                onChange={(e) => setTimeout(parseInt(e.target.value) || 1)}
                className="font-mono"
                data-testid="input-timeout"
              />
            </div>
          </div>

          <div className="space-y-3">
            <Label className="text-xs font-medium uppercase tracking-wide">
              {lang === "vi" ? "Cường Độ Bruteforce ASLR" : "ASLR Bruteforce Intensity"}
            </Label>
            <Slider
              value={[maxAttempts / 100]}
              onValueChange={(value) => setMaxAttempts(value[0] * 100)}
              max={100}
              step={1}
              className="w-full"
              data-testid="slider-intensity"
            />
            <p className="text-xs text-muted-foreground">
              {lang === "vi"
                ? "Cường độ cao hơn = nhiều lần thử hơn mỗi chu kỳ spawn"
                : "Higher intensity = more attempts per spawn cycle"}
            </p>
          </div>

          <div className="flex gap-2 pt-2">
            <Button
              onClick={handleRun}
              disabled={createAttemptMutation.isPending}
              className="gap-2"
              data-testid="button-run-exploit"
            >
              {createAttemptMutation.isPending ? (
                <>
                  <RefreshCw className="h-4 w-4 animate-spin" />
                  {lang === "vi" ? "Đang Chạy..." : "Running..."}
                </>
              ) : (
                <>
                  <Play className="h-4 w-4" />
                  {lang === "vi" ? "Chạy Exploit" : "Run Exploit"}
                </>
              )}
            </Button>
            <Button
              variant="outline"
              onClick={handleCopy}
              className="gap-2"
              data-testid="button-copy-code"
            >
              <Copy className="h-4 w-4" />
              {lang === "vi" ? "Sao Chép" : "Copy Code"}
            </Button>
          </div>
        </Card>
      </div>

      <div className="w-full lg:w-80 border-t lg:border-t-0 lg:border-l p-4 lg:p-6 space-y-4 lg:space-y-6 overflow-y-auto min-h-0 bg-card">
        {isLoading ? (
          <div className="space-y-4">
            <Skeleton className="h-8 w-32" />
            <div className="grid grid-cols-2 gap-3">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-24" />
              ))}
            </div>
          </div>
        ) : (
          <StatsPanel {...stats} />
        )}
        <AttemptLog attempts={attempts} />
      </div>
    </div>
  );
}
